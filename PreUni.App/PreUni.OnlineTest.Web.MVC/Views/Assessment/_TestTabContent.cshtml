@model PreUni.OnlineTest.Web.MVC.ViewModel.OnlineWritingViewModel

<style>
    .font-small {
        font: smaller;
    }
</style>

@using (Html.BeginForm("MarkNow", "Assessment", FormMethod.Post, new { ID = "FormSubmitID" }))
{
    @Html.AntiForgeryToken()

    @Html.HiddenFor(m => m.ID)
    @Html.HiddenFor(m => m.StudentID)
    @Html.HiddenFor(m => m.TestID)
    @Html.HiddenFor(m => m.IsGeneralTest)
    @Html.HiddenFor(m => m.TestTypeID)


    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

    <!--Student Info-->
    <div class="form-group">
        <div class="row">
            <label class="control-label col-md-2"> Student-Info </label>
            <div class="col-md-10">
                <p>Student ID: <span class="font-weight-bolder">@Model.StudentID</span></p>
                <p>Student Name: <span class="font-weight-bold">@Model.StudentName</span></p>
            </div>
        </div>
    </div>
    <!--./Student Info-->

    <!--Student Writing-->
    <div class="form-group">
        <div class="row">
            <label class="control-label col-md-2"> Student Writing </label>
            <div class="col-md-10">

                @*@Html.TextArea("Writing", new { rows = "10", @class = "form-control d-block" })*@
                @*@Html.TextAreaFor(model => model.WritingText, new { rows = "10", @class = "form-control d-block" })*@
                @*@Html.ValidationMessageFor(model => model.TermName, "", new { @class = "text-danger" })*@

                <div class="border border-dark px-1 px-sm-2">
                    @if (!string.IsNullOrEmpty(Model.WritingText))
                    {
                        @Html.Raw(Model.WritingText)
                    }
                    else
                    {
                        <span>Nothing Here</span>
                    }
                </div>
            </div>
        </div>
    </div>
    <!--./Student Writing-->

    <!--Original Mark-->

    <!--./Original Mark-->

    <!--Criteria Items-->
    <div class="form-group">
        <div class="row">
            <label class="control-label col-md-2"> Score </label>
            <div class="col-md-10">

                <div id="Criteria" class="Criteria d-flex flex-column">

                    <div class="d-flex flex-row">
                        <div class="px-2 mx-2 my-2 Criteria-Content"
                             selected-index=""
                             value="0">Content</div>
                        <div class="px-2 mx-2 my-2 Mark-Number Mark-Ticked">0</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">1</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">2</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">3</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">4</div>
                        <div class="px-2 mx-2 my-2 font-small original-mark">
                            Original Mark:
                        </div>
                    </div>

                    <div class="d-flex flex-row">
                        <div class="px-2 mx-2 my-2 Criteria-Content"
                             selected-index=""
                             value="0">Organization</div>
                        <div class="px-2 mx-2 my-2 Mark-Number Mark-Ticked">0</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">1</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">2</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">3</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">4</div>
                        <div class="px-2 mx-2 my-2 font-small original-mark">
                            Original Mark:
                        </div>
                    </div>

                    <div class="d-flex flex-row">
                        <div class="px-2 mx-2 my-2 Criteria-Content"
                             selected-index=""
                             value="0">Sentence & Grammar</div>
                        <div class="px-2 mx-2 my-2 Mark-Number Mark-Ticked">0</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">1</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">2</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">3</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">4</div>
                        <div class="px-2 mx-2 my-2 font-small original-mark">
                            Original Mark:
                        </div>
                    </div>

                    <div class="d-flex flex-row">
                        <div class="px-2 mx-2 my-2 Criteria-Content"
                             selected-index=""
                             value="0">Spelling & Vocabulary</div>
                        <div class="px-2 mx-2 my-2 Mark-Number Mark-Ticked">0</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">1</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">2</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">3</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">4</div>
                        <div class="px-2 mx-2 my-2 font-small original-mark">
                            Original Mark:
                        </div>
                    </div>

                    <div class="d-flex flex-row">
                        <div class="px-2 mx-2 my-2 Criteria-Content"
                             selected-index=""
                             value="0">Punctuation</div>
                        <div class="px-2 mx-2 my-2 Mark-Number Mark-Ticked">0</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">1</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">2</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">3</div>
                        <div class="px-2 mx-2 my-2 Mark-Number">4</div>
                        <div class="px-2 mx-2 my-2 font-small original-mark">
                            Original Mark:
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--./Criteria Items-->

    <!--Total Score-->
    <div class="form-group">
        <div class="row">
            <label class="control-label col-md-2"> Total Score </label>
            <div class="col-md-7 text-center">
                <h3 id="Total-Score">0</h3>
                @*<input type="hidden" id="Mark" value="" />*@
                @Html.HiddenFor(m => m.Mark)
            </div>
        </div>
    </div>
    <!--./Total Score-->

    <!--Marker-->
    <div class="form-group">
        <div class="row">
            <label class="control-label col-md-2"> Marker </label>
            <div class="col-md-10">
                @Html.TextBoxFor(model => model.Marker, new { @class = "form-control" })
                @*@Html.ValidationMessageFor(model => model.TermName, "", new { @class = "text-danger" })*@
            </div>
        </div>
    </div>
    <!--./Marker-->

    <!--Comment-->
    <div class="form-group">
        <div class="row">
            <label class="control-label col-md-2"> Comment </label>
            <div class="col-md-10">
                @*@Html.TextArea("Comment", new { rows = "7", @class = "form-control d-block" })*@
                @Html.TextAreaFor(model => model.Comment, new { rows = "10", @class = "form-control d-block" })
                @*@Html.ValidationMessageFor(model => model.TermName, "", new { @class = "text-danger" })*@
            </div>
        </div>
    </div>
    <!--./Comment-->

    <!--Submit-->
    <div class="form-group">
        <div class="row">
            <label class="control-label col-md-2"> </label>
            <div class="col-md-10">
                <input type="submit" value="Save" class="btn btn-primary btn-block" />
            </div>
        </div>
    </div>
    <!--./Submit-->
}

<script>

    function ReadOrigianlMark(idx,value) {

        //alert(idx);
        //alert(value[idx]);

        // read value and
        var targetSelector = '.original-mark:eq(' + idx + ')';
        // display it on html element
        $(targetSelector).text('Original Mark: ' + value[idx]);
    }

    function InitializeCriteria() {

        var resultMarks = '@Model.Mark';

        if (resultMarks == '')
            return;

        var res = resultMarks.split("");

        for (var i = 0; i < res.length; i++) {

            var targetString = '.Mark-Number:eq(' + res[i] + ')';

            // Note: nth-child starts from 1 not 0
            var targetElement = $('#Criteria div:nth-child(' + (i+1) + ')').find(targetString);

            OnClick_CriteriaItem(targetElement);
        }
    }

    InitializeCriteria();

    ReadOrigianlMark(0, '@Model.OriginalMark');
    ReadOrigianlMark(1, '@Model.OriginalMark');
    ReadOrigianlMark(2, '@Model.OriginalMark');
    ReadOrigianlMark(3, '@Model.OriginalMark');
    ReadOrigianlMark(4, '@Model.OriginalMark');

    $(".Mark-Number").click(function () {
        OnClick_CriteriaItem(this);
    });

    // obj means Criteria -> n-th Criteria -> a html element  of 3 or 4
    function OnClick_CriteriaItem(obj) {

        var grade = $(obj).text();

        //var criteria_item = $(obj).parent().children('.Criteria-Content').text();

        var markFound = $(obj).parent().find(".Mark-Ticked");
        if (markFound.length == 0) {
            $(obj).addClass("Mark-Ticked");
        }
        else {

            // if there's the existing one, selected-index is the same, it's ok, otherweise
            $(markFound).removeClass("Mark-Ticked");
            $(obj).addClass("Mark-Ticked");
        }

        $(obj).parent().children('.Criteria-Content').attr('selected-index', grade);
        $(obj).parent().children('.Criteria-Content').attr('value', grade);

        var resutlForSubmission = CalculateTotalScore();

        $('#Mark').attr('value', resutlForSubmission);
        var score = $('#Mark').attr('value');
    }

    function CalculateTotalScore() {

        var score1 = $('.Criteria').find('.Criteria-Content:eq(0)').attr('value');
        var score2 = $('.Criteria').find('.Criteria-Content:eq(1)').attr('value');
        var score3 = $('.Criteria').find('.Criteria-Content:eq(2)').attr('value');
        var score4 = $('.Criteria').find('.Criteria-Content:eq(3)').attr('value');
        var score5 = $('.Criteria').find('.Criteria-Content:eq(4)').attr('value');

        var total = 0;
        total = parseInt(score1) + parseInt(score2) + parseInt(score3) + parseInt(score4) + parseInt(score5);

        $('#Total-Score').text(total);

        return score1 + score2 + score3 + score4 + score5;
    }

</script>